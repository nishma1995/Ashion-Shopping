<!DOCTYPE html>
<html lang="zxx">

<head>
    <meta charset="UTF-8">
    <meta name="description" content="Ashion Template">
    <meta name="keywords" content="Ashion, unica, creative, html">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Ashion</title>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Cookie&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <!-- Css Styles -->
    <link rel="stylesheet" href="/css/landing/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="/css/font-awesome.min.css" type="text/css">
    <link rel="stylesheet" href="/css/landing/elegant-icons.css" type="text/css">
    <link rel="stylesheet" href="/css/landing/jquery-ui.min.css" type="text/css">
    <link rel="stylesheet" href="/css/landing/magnific-popup.css" type="text/css">
    <link rel="stylesheet" href="/css/landing/owl.carousel.min.css" type="text/css">
    <link rel="stylesheet" href="/css/landing/slicknav.min.css" type="text/css">
    <link rel="stylesheet" href="/css/landing/style2.css" type="text/css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">


    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>


</head>

<body>
    <!-- Page Preloder -->
    <div id="preloder">
        <div class="loader"></div>
    </div>

    <!-- Offcanvas Menu Begin -->
    <div class="offcanvas-menu-overlay"></div>
    <div class="offcanvas-menu-wrapper">
        <div class="offcanvas__close">+</div>
        <ul class="offcanvas__widget">
            <li><span class="icon_search search-switch"></span></li>
                            <li class="dropdown">
                                <a class="dropdown-toggle" role="button" id="userDropdown" data-bs-toggle="dropdown"
                                    aria-expanded="false">
                                    <i class="fa fa-user"></i>
                                </a>
                                <ul class="dropdown-menu" aria-labelledby="userDropdown">
                                    {{#if User}}
                                    <li><a class="dropdown-item" href="/myprofile">My Profile</a></li>
                                    <li><a class="dropdown-item" href="/wishlist">Wishlist</a></li>
                                    <li><a class="dropdown-item" href="/myorder">Orders</a></li>
                                    <li><a class="dropdown-item" href="/wallet">Wallet</a></li>
                                    <li><a class="dropdown-item" href="/logout">Logout</a></li>
                                    {{else if googleUser}}
                                    <li><a class="dropdown-item" href="/myprofile">My Profile</a></li>
                                    <li><a class="dropdown-item" href="/wishlist">Wishlist</a></li>
                                    <li><a class="dropdown-item" href="/myorder">Orders</a></li>
                                    <li><a class="dropdown-item" href="/wallet">Wallet</a></li>
                                    <li><a class="dropdown-item" href="/logout">Logout</a></li>
                                    {{else}}
                                    <!-- Show Nothing -->
                                    {{/if}}
                                </ul>
                            </li>
                            <li><a href="/cart"><i class="fa fa-shopping-cart"></i></a></li>
                        </ul>
        <div class="offcanvas__logo">
            <a href="/"><img src="img/logo.png" alt=""></a>
        </div>
        <div id="mobile-menu-wrap"></div>
        <div class="offcanvas__auth">
            <a href="#">Login</a>
            <a href="#">Register</a>
        </div>
    </div>
    <!-- Offcanvas Menu End -->

    <header class="header">
        <div class="container-fluid">
            <div class="row">
                <div class="col-xl-3 col-lg-2">
                    <div class="header__logo">
                        <a href="/"><img src="/img/logo.png" alt=""></a>
                    </div>
                </div>
                <div class="col-xl-6 col-lg-7">
                    <nav class="header__menu">
                        <ul>
                            <li class="active"><a href="/">Home</a></li>
                            <li><a href="/category?category=Women">Women</a></li>
                            <li><a href="/category?category=Men">Men</a></li>
                            <li><a href="/category?category=Kids">kids</a></li>
                            <li><a href="/category?category=Accessories">Accessories</a>
                            </li>
                        </ul>
                    </nav>
                </div>

                <div class="col-lg-3">
                    <div class="header__right">
                        <ul class="header__right__widget">
                            <li><span class="icon_search search-switch"></span></li>
                            <li class="dropdown">
                                <a class="dropdown-toggle" role="button" id="userDropdown" data-bs-toggle="dropdown"
                                    aria-expanded="false">
                                    <i class="fa fa-user"></i>
                                </a>
                                <ul class="dropdown-menu" aria-labelledby="userDropdown">
                                    {{#if User}}
                                    <li><a class="dropdown-item" href="/myprofile">My Profile</a></li>
                                    <li><a class="dropdown-item" href="/wishlist">Wishlist</a></li>
                                    <li><a class="dropdown-item" href="/myorder">Orders</a></li>
                                    <li><a class="dropdown-item" href="/wallet">Wallet</a></li>
                                    <li><a class="dropdown-item" href="/logout">Logout</a></li>
                                    {{else if googleUser}}
                                    <li><a class="dropdown-item" href="/myprofile">My Profile</a></li>
                                    <li><a class="dropdown-item" href="/wishlist">Wishlist</a></li>
                                    <li><a class="dropdown-item" href="/myorder">Orders</a></li>
                                    <li><a class="dropdown-item" href="/wallet">Wallet</a></li>
                                    <li><a class="dropdown-item" href="/logout">Logout</a></li>
                                    {{else}}
                                    <!-- Show Nothing -->
                                    {{/if}}
                                </ul>
                            </li>
                            <li><a href="/cart"><i class="fa fa-shopping-cart"></i></a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="canvas__open">
                <i class="fa fa-bars"></i>
            </div>
        </div>
    </header>
    <!-- Header Section End -->

    <!-- Breadcrumb Begin -->
    <div class="breadcrumb-option">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="breadcrumb__links">
                        <a href="/"><i class="fa fa-home"></i> Home</a>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Breadcrumb End -->
    <section class="checkout spad">
        <div class="container">
            
            <div class="row">
                <div class="col-lg-12">
                     <div class="d-flex justify-content-end mb-3">
                    <button id="listCouponBtn" class="btn btn-secondary text-nowrap">View Coupons</button>
                </div>

                        
                    <h6 class="coupon__link" id="couponLink"><span class="icon_tag_alt"></span> <a href="#"
                            id="showCouponInput">Have a coupon?</a> Click
                        here to enter your code.</h6>

                    <div class="row g-3 coupon-input" id="couponInput" style="display: none;">
                        <div class="col-md-8 d-flex align-items-center">
                            <input type="text" class="form-control mb-5" id="couponCodeInput"
                                placeholder="Enter coupon code">

                            <button id="applyCouponBtn" class="btn btn-primary flex-grow-1 ml-4 mb-5">Apply</button>
                              <button id="removeCouponBtn" class="btn btn-secondary flex-grow-1 ml-4 mb-5 text-nowrap">Remove Coupon</button>
                              
                        </div>

                    </div>


                

                </div>
                <div id="message" style="color:green" class="ml-4"></div>

            </div>
            <div id="errorMessage" class="alert alert-danger" style="display: none;">
                <!-- Error message will be displayed here -->
            </div>

            <form action="/placeOrder" id="checkout__form" class="checkout__form" method="POST">
                <div class="row">

                    <div class="col-lg-6">

                        <button type="button" id="addAddressBtn" class="btn btn-secondary mb-3">Add new Address</button>

                        <div class="card mb-3">
                            <div class="card-body">


                                {{#each address}}
                                <div>
                                    <h5 class="card-title mt-5">Address {{@index}}</h5>
                                </div>
                                <div class="mb-4">

                                    <input type="radio" class="choose-address-radio" name="selectedAddressId"
                                        value="{{this._id}}" required checked>



                                    {{!--<input type="hidden" id="selected-address-id" name="selectedAddressId"
                                        value="">--}}
                                </div>
                                <div class="row">

                                    <div class="col-md-6">

                                        <h6><strong>First Name:</strong> {{this.firstname}}</h6>
                                        <h6><strong>Last Name:</strong> {{this.lastname}}</h6>
                                        <h6><strong>Email:</strong> {{this.email}}</h6>
                                        <h6><strong>Phone Number:</strong> {{this.phonenumber}}</h6>
                                    </div>
                                    <div class="col-md-6">
                                        <h6><strong>Address:</strong> {{this.address}}</h6>
                                        <h6><strong>City:</strong> {{this.city}}</h6>
                                        <h6><strong>State:</strong> {{this.state}}</h6>
                                        <h6><strong>Pincode:</strong> {{this.pincode}}</h6>
                                        <h6><strong>Landmark:</strong> {{this.landmark}}</h6>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <button type="button" id="editbtn" class="btn btn-secondary editbtn"
                                        data-address-id="{{this._id}}">Edit</button>

                                </div>
                                {{/each}}

                            </div>

                        </div>

                    </div>

                    <div class="col-lg-6">

                        <div class="checkout__order">
                            <h5>Your order</h5>
                            <div class="checkout__order__product">

                                <ul>
                                    <li>
                                        <span class="top__text">Product</span>
                                        {{! <span class="top__text__quantity">Quantity</span>}}
                                        <span class="top__text__right">Total</span>
                                    </li>
                                    {{#each cartWithProducts}}
                                    <li>{{addOne @index}}. {{this.name}} <span>₹ {{this.totalprice}}</span></li>

                                    {{/each}}
                                </ul>
                            </div>
                            <div class="checkout__order__total">
                                <ul>
                                    <li>Subtotal <span>₹ {{subtotal}}</span></li>
                                    <li>Delivery Charge <span>₹ {{deliverycharge}}</span></li>
                                    <li>Discount <span id="discountAmount">₹0 </span></li>
                                    <input type="hidden" name="total" value="{{total}}">
                                    <li>Total <span id="totalAmount" name="totalAmount">₹ {{total}}</span></li>
                                </ul>
                            </div>
                            <div class="checkout__order__widget">
                                <label for="cash-on-delivery">
                                    Cash on delivery
                                    <input type="radio" id="cash-on-delivery" name="paymentmethod"
                                        value="cash-on-delivery" required checked>
                                    <span class="checkmark"></span>
                                </label>
                                <label for="credit-debit-card">
                                   Card/Net banking
                                    <input type="radio" id="credit-debit-card" name="paymentmethod" value="razorpay"
                                        required>
                                    <span class="checkmark"></span>
                                </label>
                                <label for="Wallet">
                                    Wallet
                                    <input type="radio" id="Wallet" name="paymentmethod" value="wallet" required>
                                    <span class="checkmark"></span>
                                </label>
                            </div>

                            <button type="submit" class="site-btn">Place order</button>

                            <input type="hidden" id="product-id" name="productIds" value="{{productIds}}">

                            {{!--<input type="hidden" id="amount" name="amount" value="{{total}}">--}}
                            <input type="hidden" id="totalAmountInput" name="totalAmountInput" value="{{total}}">

                            <input type="hidden" id="couponIdInput" name="couponIdInput" value="">



                        </div>
                    </div>
                </div>
            </form>
        </div>
    </section>


    <!-- Instagram Begin -->
    <div class="instagram">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-2 col-md-4 col-sm-4 p-0">
                    <div class="instagram__item set-bg" data-setbg="img/instagram/insta-1.jpg">
                        <div class="instagram__text">
                            <i class="fa fa-instagram"></i>
                            <a href="#">@ ashion_shop</a>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-sm-4 p-0">
                    <div class="instagram__item set-bg" data-setbg="img/instagram/insta-2.jpg">
                        <div class="instagram__text">
                            <i class="fa fa-instagram"></i>
                            <a href="#">@ ashion_shop</a>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-sm-4 p-0">
                    <div class="instagram__item set-bg" data-setbg="img/instagram/insta-3.jpg">
                        <div class="instagram__text">
                            <i class="fa fa-instagram"></i>
                            <a href="#">@ ashion_shop</a>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-sm-4 p-0">
                    <div class="instagram__item set-bg" data-setbg="img/instagram/insta-4.jpg">
                        <div class="instagram__text">
                            <i class="fa fa-instagram"></i>
                            <a href="#">@ ashion_shop</a>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-sm-4 p-0">
                    <div class="instagram__item set-bg" data-setbg="img/instagram/insta-5.jpg">
                        <div class="instagram__text">
                            <i class="fa fa-instagram"></i>
                            <a href="#">@ ashion_shop</a>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-4 col-sm-4 p-0">
                    <div class="instagram__item set-bg" data-setbg="img/instagram/insta-6.jpg">
                        <div class="instagram__text">
                            <i class="fa fa-instagram"></i>
                            <a href="#">@ ashion_shop</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Instagram End -->

    <!-- Footer Section Begin -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 col-md-6 col-sm-7">
                    <div class="footer__about">
                        <div class="footer__logo">
                            <a href="./index.html"><img src="img/logo.png" alt=""></a>
                        </div>
                        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt
                            cilisis.</p>
                        <div class="footer__payment">
                            <a href="#"><img src="img/payment/payment-1.png" alt=""></a>
                            <a href="#"><img src="img/payment/payment-2.png" alt=""></a>
                            <a href="#"><img src="img/payment/payment-3.png" alt=""></a>
                            <a href="#"><img src="img/payment/payment-4.png" alt=""></a>
                            <a href="#"><img src="img/payment/payment-5.png" alt=""></a>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 col-md-3 col-sm-5">
                    <div class="footer__widget">
                        <h6>Quick links</h6>
                        <ul>
                            <li><a href="#">About</a></li>
                            <li><a href="#">Blogs</a></li>
                            <li><a href="#">Contact</a></li>
                            <li><a href="#">FAQ</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-2 col-md-3 col-sm-4">
                    <div class="footer__widget">
                        <h6>Account</h6>
                        <ul>
                            <li><a href="#">My Account</a></li>
                            <li><a href="#">Orders Tracking</a></li>
                            <li><a href="#">Checkout</a></li>
                            <li><a href="#">Wishlist</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-4 col-md-8 col-sm-8">
                    <div class="footer__newslatter">
                        <h6>NEWSLETTER</h6>
                        <form action="#">
                            <input type="text" placeholder="Email">
                            <button type="submit" class="site-btn">Subscribe</button>
                        </form>
                        <div class="footer__social">
                            <a href="#"><i class="fa fa-facebook"></i></a>
                            <a href="#"><i class="fa fa-twitter"></i></a>
                            <a href="#"><i class="fa fa-youtube-play"></i></a>
                            <a href="#"><i class="fa fa-instagram"></i></a>
                            <a href="#"><i class="fa fa-pinterest"></i></a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12">
                    <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                    <div class="footer__copyright__text">
                        <p>Copyright &copy;
                            <script>document.write(new Date().getFullYear());</script> All rights reserved | This
                            template is made with <i class="fa fa-heart" aria-hidden="true"></i> by <a
                                href="https://colorlib.com" target="_blank">Colorlib</a>
                        </p>
                    </div>
                    <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                </div>
            </div>
        </div>
    </footer>
    <!-- Footer Section End -->

    <!-- Search Begin -->
    <div class="search-model">
        <div class="h-100 d-flex align-items-center justify-content-center">
            <div class="search-close-switch">+</div>
            <form class="search-model-form">
                <input type="text" id="search-input" placeholder="Search here.....">
                
             <button type="button" id="clear-search" class="btn btn-primary">Clear</button>
            </form>
        </div>
    </div>
    <!-- Search End -->
  <!-- Modal -->
<div class="modal fade" id="couponModal" tabindex="-1" aria-labelledby="couponModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="couponModalLabel">Available Coupons</h5>
               {{!-- <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>--}}
            </div>
            <div class="modal-body" id="couponList">
                <!-- Coupons will be dynamically added here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


    <!-- Js Plugins -->
    <script src="/js/landing/jquery-3.3.1.min.js"></script>
    <script src="/js/landing/bootstrap.min.js"></script>
    <script src="/js/landing/jquery.magnific-popup.min.js"></script>
    <script src="/js/landing/jquery-ui.min.js"></script>
    <script src="/js/landing/mixitup.min.js"></script>
    <script src="/js/landing/jquery.countdown.min.js"></script>
    <script src="/js/landing/jquery.slicknav.js"></script>
    <script src="/js/landing/owl.carousel.min.js"></script>
    <script src="/js/landing/jquery.nicescroll.min.js"></script>
    <script src="/js/landing/main.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>

    <script>

        // const razorpayKey = 'rzp_test_cO21yg26G2GhX8'; // Your Razorpay Key

        document.addEventListener('DOMContentLoaded', function () {
             $('#clear-search').click(function () {
            $('#search-input').val(''); // Clear the input field
        });

            const editButtons = document.querySelectorAll('.editbtn');

            editButtons.forEach(function (button) {
                button.addEventListener('click', function () {
                    

                    const addressId = button.dataset.addressId;


                    window.location.href = `/editAddress/${addressId}`;
                });

                const couponLink = document.getElementById('couponLink');
                const couponInput = document.getElementById('couponInput');
                const showCouponInput = document.getElementById('showCouponInput');
                const couponCodeInput = document.getElementById('couponCodeInput');
                const applyCouponBtn = document.getElementById('applyCouponBtn');

                showCouponInput.addEventListener('click', function (event) {
                    event.preventDefault(); // Prevent default link behavior
                    couponInput.style.display = 'block'; // Show the coupon input field
                });

                applyCouponBtn.addEventListener('click', function (event) {
                    event.preventDefault();
                    const discountAmount = document.getElementById('discountAmount');
                    // const totalElem = document.getElementById('total');
                    const total = parseFloat("{{total}}");

                    const couponCode = couponCodeInput.value;

                    console.log('Coupon code:', couponCode);
                    if (couponCode === '') {
                         Swal.fire({
                                        icon: 'warning',
                                        title: 'Warning!',
                                        text: 'Please enter a coupon code.',
                                        toast: true,
                                        position: 'top',
                                        showConfirmButton: false,
                                        timer: 4000
                                    });
                  
                        return;
                    }

                    // Construct the AJAX request
                    $.ajax({
                        type: 'POST',
                        url: '/checkCoupon',
                        data: JSON.stringify({ couponCode: couponCode }),
                        contentType: 'application/json',
                        success: function (data) {
                            if (data.success) {


                               
                                const discountAmount = data.discountAmount;

                                const couponId = data.couponId
                                $('#couponIdInput').val(data.couponId);
                                const couponIdss = $('#couponIdInput').val();

                                if (discountAmount < total) {
                                    $('#discountAmount').text(`₹ ${discountAmount}`);
                                    const discountedTotal = total - discountAmount;
                                    $('#totalAmount').text(`₹ ${discountedTotal}`);
                                }

                                else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'ERROR!',
                                        text: 'Coupon cannot be applied  for this purchase because minamount for purchase for this coupon is 500!',
                                        toast: true,
                                        position: 'top',
                                        showConfirmButton: false,
                                        timer: 4000
                                    });
                                }

                            } else {
                                //  alert(data.message); // Show error message from the server
                                Swal.fire({
                                    icon: 'error',
                                    title: 'ERROR!',
                                    text: data.message,
                                    toast: true,
                                    position: 'top',
                                    showConfirmButton: false,
                                    timer: 4000
                                });


                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('AJAX error:', error);
                            //alert(xhr.responseJSON.message );
                            Swal.fire({
                                icon: 'error',
                                title: 'ERROR!',
                                text: xhr.responseJSON.message,
                                toast: true,
                                position: 'top',
                                showConfirmButton: false,
                                timer: 4000
                            });

                        }
                    });
                });

                couponInput.style.display = 'none';



            });

             removeCouponBtn.addEventListener('click', function (event) {
                const discountAmount = document.getElementById('discountAmount');
               $('#discountAmount').text(`₹ 0`);

             })


            const chooseAddressRadios = document.querySelectorAll('.choose-address-radio');


            chooseAddressRadios.forEach(function (radio) {
                radio.addEventListener('change', function () {

                    const addressId = this.value;


                    document.getElementById('selected-address-id').value = addressId;

                    const selectedCard = this.closest('.card');
                    if (selectedCard) {
                        selectedCard.classList.add('selected-address');
                    }

                });
            });

            document.getElementById('checkout__form').addEventListener('submit', async function (event) {

                event.preventDefault();

                const paymentMethod = document.querySelector('input[name="paymentmethod"]:checked').value;
                const couponId = $('#couponIdInput').val();
                const totalAmountElem = document.getElementById('totalAmount'); // Get the totalAmount element
                const totalAmountValue = totalAmountElem.textContent.trim(); // Get the text content and trim any extra spaces
                const amount = parseFloat(totalAmountValue.replace('₹ ', ''));

                const totalAmountInput = document.getElementById('totalAmountInput');
                totalAmountInput.value = amount

                const selectedAddressId = document.querySelector('input[name="selectedAddressId"]:checked').value;
                const productIds = $('#product-id').val();

                // Prepare data to send to the payment failure endpoint
                const failureData = {
                    selectedAddressId: selectedAddressId,
                    amount: amount,
                    couponId: couponId,
                    paymentMethod: paymentMethod,
                    productIds: productIds
                };

                // alert(failureData)


                if (paymentMethod === 'razorpay') {

                    try {
                        // Fetch endpoint to create Razorpay order
                        const response = await fetch('/createRazorpayOrder', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                amount: parseFloat($('#totalAmount').text().replace('₹ ', '')), couponId, failureData// Convert to number
                            }),
                        });
                        const data = await response.json();

                        if (data && data.orderId) {
                            const orderId = data.orderId;
                            const razorpayKey = data.key
                            const storedCouponId = couponId;
                            const options = {
                                key: razorpayKey, // Your Razorpay Key
                                amount: data.amount * 100, // Amount in paisa
                                currency: 'INR',
                                order_id: orderId,
                                //callback_url:"/isOrderCompleted",
                                handler: function (response) {
                                    //  alert("abcd")
                                    if (response.razorpay_payment_id) {
                                        //Payment success, redirect to order success page
                                        event.target.submit();
                                    } else {
                                        //Payment failure
                                        console.error('Payment failed:', response.error);
                                        // Optionally, redirect to failure page or show an error message


                                    }

                                },
                                prefill: {
                                    // Add customer details if needed
                                },
                                notes: {


                                },
                            };
                            const rzp = new Razorpay(options);
                            rzp.on('payment.failed', function (response) {
                                // Handle failed payment if needed
                                console.error('Payment failed:', response.error);


                                console.log('Failure data:', failureData);



                                console.log(JSON.stringify(failureData));

                                fetch('/orderFailure', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({ failureData: failureData }),
                                }).then(response => response.json())
                                    .then(data => {
                                        // Redirect to order failure page with failureData details
                                        if (data.success) {
                                            console.log("ppppp")
                                            let id=data.orderId
                                            window.location.href = `/orderFailurePage/${id}`; // Update with your failure page URL
                                        } else {
                                            console.error('Failed to process order failure:', data.message);
                                            // Show an error message or handle the error as needed
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error processing order failure:', error.message);
                                        // Show an error message or handle the error as needed
                                    });


                            });
                            rzp.open(); // Open Razorpay payment modal
                        }
                    } catch (error) {
                        console.error('Error creating Razorpay order:', error);
                        // Handle error or show a message to the user
                    }
                } else {

                    Swal.fire({
                        title: 'Are you sure?',
                        text: 'You want  to place the order?',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'Yes'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            
                            if (paymentMethod === 'wallet'||paymentMethod === 'cash-on-delivery')


                                console.log("gdhckscfd")

                                // Swal.fire({
                                //    icon: 'success',
                                //  title: 'Success!',
                                //   text: 'order placed successfully!',
                                //  toast: true,
                                //  position: 'top',
                                //   showConfirmButton: false,
                                //   timer: 4000
                                // });
                                // setTimeout(() => {
                                // Submit the form
                                event.target.submit();
                            //}, 1000); // Adjust the delay time as needed
                        }
                    })

                }
            });
            const urlParams = new URLSearchParams(window.location.search);
            const message = urlParams.get('message');


            const messageDiv = document.getElementById('message');
            if (message) {
                messageDiv.innerText = message;
            }


        });


        $(document).ready(function () {


            const viewCouponBtn=$('#listCouponBtn')
             const couponModal = $('#couponModal');
            viewCouponBtn.click(function()
            {
                
                $.ajax({
                    url:"/couponlist",
                    method:"GET",
                    success:function(data)
                    {
                       
                        populateCouponModal(data)
                        couponModal.modal('show')
                    },
                    error:function(xhr,status,error)
                    {
                        
                    }
                })
                
            }
            )



            

            const addAddressButton = document.getElementById('addAddressBtn');
            addAddressButton.addEventListener('click', function () {
                window.location.href = '/addAddress'
            })
            // Capture form submission
            $('.search-model-form').on('submit', function (event) {
                event.preventDefault(); // Prevent the default form submission

                // Get the entered search text
                const searchText = $('#search-input').val();

                // Construct the URL with the search query as a parameter
                const searchUrl = `/search?search=${encodeURIComponent(searchText)}`;

                // Redirect to the search URL
                window.location.href = searchUrl;
            });

            function populateCouponModal(coupons)
            {
                const couponlist=$('#couponList')
                couponlist.empty()
               //  coupons.forEach(function (coupon) {
                 // Create the table structure
    const tableHTML = `
        <table class="table">
            <thead>
                <tr>
                    <th>Coupon Code</th>
                    <th>Discount Amount</th>
                </tr>
            </thead>
            <tbody>
                ${coupons.map(coupon =>
                    `<tr>
                        <td>${coupon.code}</td>
                        <td>${coupon.discountAmount}</td>
                    </tr>`
                ).join('')}
            </tbody>
        </table>
    `;

    // Append the table HTML to the modal body
    couponlist.append(tableHTML);
          //  });
            }
            $('#couponModalCloseBtn').click(function () {
        couponModal.modal('hide');
    });
            
        });
        const urlParams = new URLSearchParams(window.location.search);
        const error = urlParams.get('error');

        // Display error message if it exists
        if (error) {
            const errorMessageDiv = document.getElementById('errorMessage');
            errorMessageDiv.textContent = error;
            errorMessageDiv.style.display = 'block'; // Show the error message div
        }



    </script>
</body>

</html>